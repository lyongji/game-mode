

#include <memory>
#include <print>
#include <typeindex>
#include <unordered_map>
#include <vector>

// å‰å‘å£°æ˜æ¸¸æˆå¯¹è±¡ç±»
class æ¸¸æˆå¯¹è±¡;

// ç»„ä»¶åŸºç±»
class ç»„ä»¶ {
public:
  virtual ~ç»„ä»¶() = default; // è™šææ„å‡½æ•°ç¡®ä¿æ­£ç¡®é‡Šæ”¾æ´¾ç”Ÿç±»èµ„æº

  /**
   * æ¯å¸§æ›´æ–°ç»„ä»¶çš„é€»è¾‘
   * @param æ‰€å±å¯¹è±¡ æŒ‡å‘æ‹¥æœ‰è¯¥ç»„ä»¶çš„æ¸¸æˆå¯¹è±¡
   */
  virtual void æ›´æ–°(æ¸¸æˆå¯¹è±¡ *æ‰€å±å¯¹è±¡) = 0;

  /**
   * å¤„ç†æ¸¸æˆäº‹ä»¶
   * @param äº‹ä»¶ç±»å‹ äº‹ä»¶æ ‡è¯†ç¬¦
   * @param äº‹ä»¶æ•°æ® äº‹ä»¶ç›¸å…³æ•°æ®
   */
  virtual void å¤„ç†äº‹ä»¶(const std::string &äº‹ä»¶ç±»å‹, void *äº‹ä»¶æ•°æ®) {}
};

// æ¸¸æˆå¯¹è±¡ç±»
class æ¸¸æˆå¯¹è±¡ {
private:
  std::string å¯¹è±¡åç§°; // æ¸¸æˆå¯¹è±¡åç§°
  bool æ˜¯å¦æ¿€æ´» = true; // å¯¹è±¡æ¿€æ´»çŠ¶æ€

  // ç»„ä»¶å­˜å‚¨å®¹å™¨ï¼šä½¿ç”¨unique_ptrç®¡ç†ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ
  std::vector<std::unique_ptr<ç»„ä»¶>> ç»„ä»¶åº“;

  // ç»„ä»¶ç±»å‹ç´¢å¼•ï¼šåŠ é€Ÿç»„ä»¶æŸ¥æ‰¾
  std::unordered_map<std::type_index, ç»„ä»¶ *> ç»„ä»¶ç´¢å¼•;

public:
  explicit æ¸¸æˆå¯¹è±¡(std::string åç§° = "") : å¯¹è±¡åç§°(std::move(åç§°)) {}

  /**
   * æ·»åŠ ç»„ä»¶åˆ°æ¸¸æˆå¯¹è±¡
   * @tparam T ç»„ä»¶ç±»å‹
   * @tparam Args ç»„ä»¶æ„é€ å‚æ•°ç±»å‹
   * @param æ„é€ å‚æ•° ç»„ä»¶æ„é€ å‚æ•°
   * @return æŒ‡å‘æ–°ç»„ä»¶çš„æŒ‡é’ˆ
   */
  template <typename T, typename... Args> T *æ·»åŠ ç»„ä»¶(Args &&...æ„é€ å‚æ•°) {
    // åˆ›å»ºç»„ä»¶å®ä¾‹
    auto æ–°ç»„ä»¶ = std::make_unique<T>(std::forward<Args>(æ„é€ å‚æ•°)...);
    auto ç»„ä»¶æŒ‡é’ˆ = æ–°ç»„ä»¶.get();

    // å­˜å‚¨ç»„ä»¶å¹¶æ›´æ–°ç´¢å¼•
    ç»„ä»¶åº“.push_back(std::move(æ–°ç»„ä»¶));
    ç»„ä»¶ç´¢å¼•[typeid(T)] = ç»„ä»¶æŒ‡é’ˆ;

    return ç»„ä»¶æŒ‡é’ˆ;
  }

  /**
   * è·å–æŒ‡å®šç±»å‹çš„ç»„ä»¶
   * @tparam T ç»„ä»¶ç±»å‹
   * @return æŒ‡å‘ç»„ä»¶çš„æŒ‡é’ˆï¼ˆæœªæ‰¾åˆ°è¿”å›nullptrï¼‰
   */
  template <typename T> T *è·å–ç»„ä»¶() {
    auto æŸ¥æ‰¾ç»“æœ = ç»„ä»¶ç´¢å¼•.find(typeid(T));
    if (æŸ¥æ‰¾ç»“æœ != ç»„ä»¶ç´¢å¼•.end()) {
      return dynamic_cast<T *>(æŸ¥æ‰¾ç»“æœ->second);
    }

    // éå†æŸ¥æ‰¾ï¼ˆç¡®ä¿ç±»å‹å®‰å…¨ï¼‰
    for (auto &ç»„ä»¶å®ä¾‹ : ç»„ä»¶åº“) {
      if (auto ç»“æœ = dynamic_cast<T *>(ç»„ä»¶å®ä¾‹.get())) {
        // æ›´æ–°ç´¢å¼•ä»¥ä¾¿ä¸‹æ¬¡å¿«é€ŸæŸ¥æ‰¾
        ç»„ä»¶ç´¢å¼•[typeid(T)] = ç»“æœ;
        return ç»“æœ;
      }
    }
    return nullptr;
  }

  /**
   * æ¯å¸§æ›´æ–°æ‰€æœ‰ç»„ä»¶
   */
  void æ›´æ–°() {
    if (!æ˜¯å¦æ¿€æ´»)
      return;

    for (auto &ç»„ä»¶å®ä¾‹ : ç»„ä»¶åº“) {
      ç»„ä»¶å®ä¾‹->æ›´æ–°(this);
    }
  }

  /**
   * å‘æ‰€æœ‰ç»„ä»¶å¹¿æ’­äº‹ä»¶
   * @param äº‹ä»¶ç±»å‹ äº‹ä»¶æ ‡è¯†ç¬¦
   * @param äº‹ä»¶æ•°æ® äº‹ä»¶ç›¸å…³æ•°æ®
   */
  void å¹¿æ’­äº‹ä»¶(const std::string &äº‹ä»¶ç±»å‹, void *äº‹ä»¶æ•°æ® = nullptr) {
    for (auto &ç»„ä»¶å®ä¾‹ : ç»„ä»¶åº“) {
      ç»„ä»¶å®ä¾‹->å¤„ç†äº‹ä»¶(äº‹ä»¶ç±»å‹, äº‹ä»¶æ•°æ®);
    }
  }

  // è®¾ç½®æ¿€æ´»çŠ¶æ€
  void è®¾ç½®æ¿€æ´»(bool æ¿€æ´») { æ˜¯å¦æ¿€æ´» = æ¿€æ´»; }

  // è·å–å¯¹è±¡åç§°
  const std::string &è·å–åç§°() const { return å¯¹è±¡åç§°; }
};

// ====================== å…·ä½“ç»„ä»¶å®ç° ======================

// å¯ç§»åŠ¨ç»„ä»¶ï¼šå¤„ç†å¯¹è±¡ä½ç½®å’Œç§»åŠ¨é€»è¾‘
class å¯ç§»åŠ¨ç»„ä»¶ : public ç»„ä»¶ {
public:
  struct ä½ç½® {
    float x = 0, y = 0, z = 0;
  };
  struct é€Ÿåº¦ {
    float x = 0, y = 0, z = 0;
  };

  ä½ç½® å½“å‰ä½ç½®;
  é€Ÿåº¦ å½“å‰é€Ÿåº¦;

  void æ›´æ–°(æ¸¸æˆå¯¹è±¡ *æ‰€å±å¯¹è±¡) override {
    // æ›´æ–°ä½ç½®
    å½“å‰ä½ç½®.x += å½“å‰é€Ÿåº¦.x;
    å½“å‰ä½ç½®.y += å½“å‰é€Ÿåº¦.y;
    å½“å‰ä½ç½®.z += å½“å‰é€Ÿåº¦.z;

    std::print("{} ç§»åŠ¨åˆ° ({}, {}, {})\n", æ‰€å±å¯¹è±¡->è·å–åç§°(), å½“å‰ä½ç½®.x,
               å½“å‰ä½ç½®.y, å½“å‰ä½ç½®.z);
  }
};

// ç©å®¶æ§åˆ¶ç»„ä»¶ï¼šå¤„ç†ç©å®¶è¾“å…¥
class ç©å®¶æ§åˆ¶ç»„ä»¶ : public ç»„ä»¶ {
public:
  void æ›´æ–°(æ¸¸æˆå¯¹è±¡ *æ‰€å±å¯¹è±¡) override {
    // è·å–åŒå¯¹è±¡çš„ç§»åŠ¨ç»„ä»¶
    if (auto ç§»åŠ¨ç»„ä»¶ = æ‰€å±å¯¹è±¡->è·å–ç»„ä»¶<å¯ç§»åŠ¨ç»„ä»¶>()) {
      // æ¨¡æ‹ŸæŒ‰é”®æ£€æµ‹
      if (æ¨¡æ‹ŸæŒ‰é”®æŒ‰ä¸‹(87)) { // Wé”®
        ç§»åŠ¨ç»„ä»¶->å½“å‰é€Ÿåº¦.y += 0.1f;
        std::print("â†‘ åŠ é€Ÿ\n");
      }
      if (æ¨¡æ‹ŸæŒ‰é”®æŒ‰ä¸‹(83)) { // Sé”®
        ç§»åŠ¨ç»„ä»¶->å½“å‰é€Ÿåº¦.y -= 0.1f;
        std::print("â†“ å‡é€Ÿ\n");
      }
    }
  }

private:
  // æ¨¡æ‹ŸæŒ‰é”®æ£€æµ‹ï¼ˆå®é™…é¡¹ç›®ä¸­æ›¿æ¢ä¸ºçœŸå®è¾“å…¥ç³»ç»Ÿï¼‰
  bool æ¨¡æ‹ŸæŒ‰é”®æŒ‰ä¸‹(int é”®ç ) {
    static int è®¡æ•°å™¨ = 0;
    return (++è®¡æ•°å™¨ % 30) < 3; // æ¯30å¸§è§¦å‘3å¸§
  }
};

// ç”Ÿå‘½å€¼ç»„ä»¶ï¼šç®¡ç†å¯¹è±¡ç”Ÿå‘½çŠ¶æ€
class ç”Ÿå‘½å€¼ç»„ä»¶ : public ç»„ä»¶ {
  int å½“å‰ç”Ÿå‘½å€¼;
  int æœ€å¤§ç”Ÿå‘½å€¼;

public:
  ç”Ÿå‘½å€¼ç»„ä»¶(int æœ€å¤§ç”Ÿå‘½) : å½“å‰ç”Ÿå‘½å€¼(æœ€å¤§ç”Ÿå‘½), æœ€å¤§ç”Ÿå‘½å€¼(æœ€å¤§ç”Ÿå‘½) {}

  void æ›´æ–°(æ¸¸æˆå¯¹è±¡ *æ‰€å±å¯¹è±¡) override {
    // æ¨¡æ‹Ÿæ¯å¸§ç”Ÿå‘½å€¼å‡å°‘
    if (å½“å‰ç”Ÿå‘½å€¼ > 0) {
      å½“å‰ç”Ÿå‘½å€¼ -= 1;
      std::print("{} ç”Ÿå‘½å€¼: {}/{}\n", æ‰€å±å¯¹è±¡->è·å–åç§°(), å½“å‰ç”Ÿå‘½å€¼,
                 æœ€å¤§ç”Ÿå‘½å€¼);

      if (å½“å‰ç”Ÿå‘½å€¼ <= 0) {
        std::print("ğŸ’€ {} è¢«é”€æ¯!\n", æ‰€å±å¯¹è±¡->è·å–åç§°());
        æ‰€å±å¯¹è±¡->è®¾ç½®æ¿€æ´»(false);
      }
    }
  }

  void å¤„ç†äº‹ä»¶(const std::string &äº‹ä»¶ç±»å‹, void *äº‹ä»¶æ•°æ®) override {
    if (äº‹ä»¶ç±»å‹ == "å—åˆ°ä¼¤å®³") {
      int ä¼¤å®³å€¼ = *static_cast<int *>(äº‹ä»¶æ•°æ®);
      å½“å‰ç”Ÿå‘½å€¼ -= ä¼¤å®³å€¼;
      std::print("âš¡ {} å—åˆ° {} ç‚¹ä¼¤å®³!\n", "ç”Ÿå‘½å€¼ç»„ä»¶", ä¼¤å®³å€¼);
    }
  }

  const std::string è·å–åç§°() const { return "ç”Ÿå‘½å€¼ç»„ä»¶"; }
};

// ====================== æ¸¸æˆåœºæ™¯ç¤ºä¾‹ ======================

int main() {
  // åˆ›å»ºç©å®¶å¯¹è±¡
  auto ç©å®¶ = std::make_unique<æ¸¸æˆå¯¹è±¡>("ç©å®¶è§’è‰²");
  ç©å®¶->æ·»åŠ ç»„ä»¶<å¯ç§»åŠ¨ç»„ä»¶>();
  ç©å®¶->æ·»åŠ ç»„ä»¶<ç©å®¶æ§åˆ¶ç»„ä»¶>();
  ç©å®¶->æ·»åŠ ç»„ä»¶<ç”Ÿå‘½å€¼ç»„ä»¶>(100);

  // åˆ›å»ºæ•Œäººå¯¹è±¡
  auto æ•Œäºº = std::make_unique<æ¸¸æˆå¯¹è±¡>("æ•Œäºº");
  æ•Œäºº->æ·»åŠ ç»„ä»¶<å¯ç§»åŠ¨ç»„ä»¶>()->å½“å‰é€Ÿåº¦ = {0.2f, 0.0f, 0.0f};
  æ•Œäºº->æ·»åŠ ç»„ä»¶<ç”Ÿå‘½å€¼ç»„ä»¶>(50);

  // æ¸¸æˆä¸»å¾ªç¯
  for (int å¸§æ•° = 0; å¸§æ•° < 40; ++å¸§æ•°) {
    std::print("\n===== å¸§ {} =====\n", å¸§æ•°);
    // æ›´æ–°æ¸¸æˆå¯¹è±¡
    ç©å®¶->æ›´æ–°();
    æ•Œäºº->æ›´æ–°();

    // æ¯30å¸§æ•Œäººå—åˆ°ä¼¤å®³
    if (å¸§æ•° % 30 == 0 && å¸§æ•° > 0) {
      int ä¼¤å®³å€¼ = 15;
      æ•Œäºº->å¹¿æ’­äº‹ä»¶("å—åˆ°ä¼¤å®³", &ä¼¤å®³å€¼);
    }
  }

  return 0;
}
