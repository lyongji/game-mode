#include <concepts>
#include <memory>
#include <print> // C++23 çš„æ ¼å¼åŒ–è¾“å‡ºåº“
#include <string>
#include <vector>

// æ¸¸æˆè§’è‰²ç±» - æœ€ç»ˆäº§å“
class æ¸¸æˆè§’è‰² {
public:
  void è®¾ç½®èŒä¸š(std::string_view èŒä¸š) { èŒä¸š = èŒä¸š; }
  void è®¾ç½®æ­¦å™¨(std::string_view æ­¦å™¨) { æ­¦å™¨ = æ­¦å™¨; }
  void è®¾ç½®æŠ¤ç”²(std::string_view æŠ¤ç”²) { æŠ¤ç”² = æŠ¤ç”²; }
  void è®¾ç½®ç­‰çº§(int ç­‰çº§) { ç­‰çº§ = ç­‰çº§; }
  void æ·»åŠ æŠ€èƒ½(std::string_view æŠ€èƒ½) {
    æŠ€èƒ½åˆ—è¡¨.push_back(std::string(æŠ€èƒ½));
  }

  void æ˜¾ç¤ºå±æ€§() const {
    using namespace std; // å…è®¸ä½¿ç”¨println

    println("\nğŸ® è§’è‰²åˆ›å»ºå®Œæˆ:");
    println("  ğŸ­ èŒä¸š: {}", èŒä¸š);
    println("  âš”ï¸ æ­¦å™¨: {}", æ­¦å™¨);
    println("  ğŸ›¡ï¸ æŠ¤ç”²: {}", æŠ¤ç”²);
    println("  ğŸ“ˆ ç­‰çº§: {}", ç­‰çº§);

    print("  ğŸ§ª æŠ€èƒ½: ");
    for (size_t i = 0; i < æŠ€èƒ½åˆ—è¡¨.size(); ++i) {
      print("{}", æŠ€èƒ½åˆ—è¡¨[i]);
      if (i < æŠ€èƒ½åˆ—è¡¨.size() - 1)
        print(", ");
    }
    println("\n");
  }

private:
  std::string èŒä¸š{"æœªé€‰æ‹©"};
  std::string æ­¦å™¨{"æ— "};
  std::string æŠ¤ç”²{"æ— "};
  int ç­‰çº§{1};
  std::vector<std::string> æŠ€èƒ½åˆ—è¡¨;
};

// å»ºé€ è€…æ¦‚å¿µå®šä¹‰
template <typename T>
concept è§’è‰²å»ºé€ è€…æ¦‚å¿µ = requires(T t) {
  { t.æ„å»ºèŒä¸š() } -> std::same_as<void>;
  { t.æ„å»ºæ­¦å™¨() } -> std::same_as<void>;
  { t.æ„å»ºæŠ¤ç”²() } -> std::same_as<void>;
  { t.æ„å»ºç­‰çº§() } -> std::same_as<void>;
  { t.æ„å»ºæŠ€èƒ½() } -> std::same_as<void>;
  { t.è·å–è§’è‰²() } -> std::convertible_to<std::unique_ptr<æ¸¸æˆè§’è‰²>>;
};

// å»ºé€ è€…åŸºç±»æ¨¡æ¿ (ä½¿ç”¨CRTPæ¨¡å¼)
template <typename è§’è‰²å»ºé€ è€…ç±»å‹> class è§’è‰²å»ºé€ è€…åŸºç±» {
protected:
  std::unique_ptr<æ¸¸æˆè§’è‰²> è§’è‰² = std::make_unique<æ¸¸æˆè§’è‰²>();

public:
  virtual ~è§’è‰²å»ºé€ è€…åŸºç±»() = default;

  void æ„å»ºèŒä¸š() { static_cast<è§’è‰²å»ºé€ è€…ç±»å‹ *>(this)->æ„å»ºèŒä¸šå®ç°(); }
  void æ„å»ºæ­¦å™¨() { static_cast<è§’è‰²å»ºé€ è€…ç±»å‹ *>(this)->æ„å»ºæ­¦å™¨å®ç°(); }
  void æ„å»ºæŠ¤ç”²() { static_cast<è§’è‰²å»ºé€ è€…ç±»å‹ *>(this)->æ„å»ºæŠ¤ç”²å®ç°(); }
  void æ„å»ºç­‰çº§() { static_cast<è§’è‰²å»ºé€ è€…ç±»å‹ *>(this)->æ„å»ºç­‰çº§å®ç°(); }
  void æ„å»ºæŠ€èƒ½() { static_cast<è§’è‰²å»ºé€ è€…ç±»å‹ *>(this)->æ„å»ºæŠ€èƒ½å®ç°(); }

  std::unique_ptr<æ¸¸æˆè§’è‰²> è·å–è§’è‰²() { return std::move(è§’è‰²); }
};

// æˆ˜å£«å»ºé€ è€…
class æˆ˜å£«å»ºé€ è€… : public è§’è‰²å»ºé€ è€…åŸºç±»<æˆ˜å£«å»ºé€ è€…> {
  friend class è§’è‰²å»ºé€ è€…åŸºç±»<æˆ˜å£«å»ºé€ è€…>;

private:
  void æ„å»ºèŒä¸šå®ç°() { è§’è‰²->è®¾ç½®èŒä¸š("ç‹‚æˆ˜å£«"); }
  void æ„å»ºæ­¦å™¨å®ç°() { è§’è‰²->è®¾ç½®æ­¦å™¨("å·¨å‰‘"); }
  void æ„å»ºæŠ¤ç”²å®ç°() { è§’è‰²->è®¾ç½®æŠ¤ç”²("æ¿ç”²"); }
  void æ„å»ºç­‰çº§å®ç°() { è§’è‰²->è®¾ç½®ç­‰çº§(10); }
  void æ„å»ºæŠ€èƒ½å®ç°() {
    è§’è‰²->æ·»åŠ æŠ€èƒ½("æ—‹é£æ–©");
    è§’è‰²->æ·»åŠ æŠ€èƒ½("ç‹‚æš´");
    è§’è‰²->æ·»åŠ æŠ€èƒ½("å†²é”‹");
  }
};

// æ³•å¸ˆå»ºé€ è€…
class æ³•å¸ˆå»ºé€ è€… : public è§’è‰²å»ºé€ è€…åŸºç±»<æ³•å¸ˆå»ºé€ è€…> {
  friend class è§’è‰²å»ºé€ è€…åŸºç±»<æ³•å¸ˆå»ºé€ è€…>;

private:
  void æ„å»ºèŒä¸šå®ç°() { è§’è‰²->è®¾ç½®èŒä¸š("å¤§æ³•å¸ˆ"); }
  void æ„å»ºæ­¦å™¨å®ç°() { è§’è‰²->è®¾ç½®æ­¦å™¨("æ³•æ–"); }
  void æ„å»ºæŠ¤ç”²å®ç°() { è§’è‰²->è®¾ç½®æŠ¤ç”²("å¸ƒç”²"); }
  void æ„å»ºç­‰çº§å®ç°() { è§’è‰²->è®¾ç½®ç­‰çº§(8); }
  void æ„å»ºæŠ€èƒ½å®ç°() {
    è§’è‰²->æ·»åŠ æŠ€èƒ½("ç«çƒæœ¯");
    è§’è‰²->æ·»åŠ æŠ€èƒ½("å¯’å†°ç®­");
    è§’è‰²->æ·»åŠ æŠ€èƒ½("ä¼ é€æœ¯");
  }
};

// å¼“ç®­æ‰‹å»ºé€ è€…
class å¼“ç®­æ‰‹å»ºé€ è€… : public è§’è‰²å»ºé€ è€…åŸºç±»<å¼“ç®­æ‰‹å»ºé€ è€…> {
  friend class è§’è‰²å»ºé€ è€…åŸºç±»<å¼“ç®­æ‰‹å»ºé€ è€…>;

private:
  void æ„å»ºèŒä¸šå®ç°() { è§’è‰²->è®¾ç½®èŒä¸š("ç¥å°„æ‰‹"); }
  void æ„å»ºæ­¦å™¨å®ç°() { è§’è‰²->è®¾ç½®æ­¦å™¨("é•¿å¼“"); }
  void æ„å»ºæŠ¤ç”²å®ç°() { è§’è‰²->è®¾ç½®æŠ¤ç”²("çš®ç”²"); }
  void æ„å»ºç­‰çº§å®ç°() { è§’è‰²->è®¾ç½®ç­‰çº§(7); }
  void æ„å»ºæŠ€èƒ½å®ç°() {
    è§’è‰²->æ·»åŠ æŠ€èƒ½("å¤šé‡å°„å‡»");
    è§’è‰²->æ·»åŠ æŠ€èƒ½("ç²¾å‡†å°„å‡»");
    è§’è‰²->æ·»åŠ æŠ€èƒ½("é™·é˜±å¸ƒç½®");
  }
};

// å¯¼æ¼”ç±»æ¨¡æ¿ - ä¿®å¤æ„é€ å‡½æ•°é—®é¢˜
template <è§’è‰²å»ºé€ è€…æ¦‚å¿µ T> class è§’è‰²å¯¼æ¼” {
public:
  // æ·»åŠ æ„é€ å‡½æ•°è§£å†³è¯Šæ–­é—®é¢˜
  è§’è‰²å¯¼æ¼”(T &å»ºé€ è€…) : å»ºé€ è€…(&å»ºé€ è€…) {}

  void æ„å»ºè§’è‰²() {
    std::println("å¼€å§‹æ„å»ºè§’è‰²...");
    å»ºé€ è€…->æ„å»ºèŒä¸š();
    å»ºé€ è€…->æ„å»ºæ­¦å™¨();
    å»ºé€ è€…->æ„å»ºæŠ¤ç”²();
    å»ºé€ è€…->æ„å»ºç­‰çº§();
    å»ºé€ è€…->æ„å»ºæŠ€èƒ½();
    std::println("è§’è‰²æ„å»ºå®Œæˆ âœ…");
  }

  std::unique_ptr<æ¸¸æˆè§’è‰²> è·å–è§’è‰²() { return å»ºé€ è€…->è·å–è§’è‰²(); }

private:
  T *å»ºé€ è€…;
};

// è§’è‰²åˆ›å»ºå·¥å‚å‡½æ•° - æ›´æ–°ä¸ºä½¿ç”¨æ„é€ å‡½æ•°
template <è§’è‰²å»ºé€ è€…æ¦‚å¿µ T> std::unique_ptr<æ¸¸æˆè§’è‰²> åˆ›å»ºè§’è‰²() {
  T å»ºé€ è€…;
  è§’è‰²å¯¼æ¼” å¯¼æ¼”(å»ºé€ è€…); // ä½¿ç”¨æ„é€ å‡½æ•°åˆå§‹åŒ–
  å¯¼æ¼”.æ„å»ºè§’è‰²();
  return å¯¼æ¼”.è·å–è§’è‰²();
}

int main() {
  using namespace std; // å…è®¸ä½¿ç”¨println

  // åˆ›å»ºæ ‡é¢˜
  println("==========================================");
  println("      ğŸ® æ¸¸æˆè§’è‰²å»ºé€ è€…ç¤ºä¾‹ (C++23)       ");
  println("==========================================");
  println("ä½¿ç”¨ C++23 ç‰¹æ€§: <print> åº“ã€æ¦‚å¿µ(Concepts)");
  println("          å’Œæ¨¡æ¿å…ƒç¼–ç¨‹ä¼˜åŒ–\n");

  // åˆ›å»ºæˆ˜å£«è§’è‰²
  println("ğŸ› ï¸ åˆ›å»ºæˆ˜å£«è§’è‰²...");
  auto æˆ˜å£«è§’è‰² = åˆ›å»ºè§’è‰²<æˆ˜å£«å»ºé€ è€…>();
  æˆ˜å£«è§’è‰²->æ˜¾ç¤ºå±æ€§();

  // åˆ›å»ºæ³•å¸ˆè§’è‰²
  println("ğŸ› ï¸ åˆ›å»ºæ³•å¸ˆè§’è‰²...");
  auto æ³•å¸ˆè§’è‰² = åˆ›å»ºè§’è‰²<æ³•å¸ˆå»ºé€ è€…>();
  æ³•å¸ˆè§’è‰²->æ˜¾ç¤ºå±æ€§();

  // åˆ›å»ºå¼“ç®­æ‰‹è§’è‰²
  println("ğŸ› ï¸ åˆ›å»ºå¼“ç®­æ‰‹è§’è‰²...");
  auto å¼“ç®­æ‰‹è§’è‰² = åˆ›å»ºè§’è‰²<å¼“ç®­æ‰‹å»ºé€ è€…>();
  å¼“ç®­æ‰‹è§’è‰²->æ˜¾ç¤ºå±æ€§();

  // ä½¿ç”¨å¯¼æ¼”ç›´æ¥åˆ›å»ºè§’è‰²ï¼ˆä¿®å¤åï¼‰
  println("ğŸ› ï¸ ä½¿ç”¨å¯¼æ¼”ç›´æ¥åˆ›å»ºè§’è‰²...");
  æˆ˜å£«å»ºé€ è€… æˆ˜å£«å»ºé€ è€…å®ä¾‹;
  è§’è‰²å¯¼æ¼” æˆ˜å£«å¯¼æ¼”(æˆ˜å£«å»ºé€ è€…å®ä¾‹); // ä½¿ç”¨æ„é€ å‡½æ•°
  æˆ˜å£«å¯¼æ¼”.æ„å»ºè§’è‰²();
  auto è‡ªå®šä¹‰æˆ˜å£« = æˆ˜å£«å¯¼æ¼”.è·å–è§’è‰²();
  è‡ªå®šä¹‰æˆ˜å£«->æ˜¾ç¤ºå±æ€§();

  println("==========================================");
  println("      æ‰€æœ‰è§’è‰²åˆ›å»ºå®Œæ¯•ï¼Œæ¸¸æˆå¼€å§‹ï¼        ");
  println("==========================================");

  return 0;
}
